<!--二者択一の画像表示-->
{{define "findolContentBody"}}

{{range $i, $v := .FaceArray}}
<style>
@media screen and (min-width: 481px) {
    .demo-card-image.mdl-card {
    width: 512px;
    height: 512px;
    }
    #back-image-{{$i}}{
        background: center/cover;
    }
    .demo-card-image > .mdl-card__actions {
    height: 104px;
    padding: 32px;
    background: rgba(0, 0, 0, 0.2);
    }
    .demo-card-image__filename {
    color: #fff;
    font-size: 28px;
    font-weight: 1000;
    }
    .image-jump-to-article {
    opacity: 0.0;
    color: Transparent;
    width: 512;
    height: 512;
    }
}
<!--@media screen and (max-width: 760px) {-->
<!--}-->
@media screen and (max-width: 480px) {
    .demo-card-image.mdl-card {
    width: 256px;
    height: 256px;
    }
    #back-image-{{$i}}{
    background: center/cover;
    }
    .demo-card-image > .mdl-card__actions {
    height: 52px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    }
    .demo-card-image__filename {
    color: #fff;
    font-size: 14px;
    font-weight: 500;
    }
    .image-jump-to-article {
    opacity: 0.0;
    color: Transparent;
    width: 256;
    height: 256;
    }
}
<!--@media screen and (max-width: 320px) {-->
    <!--.demo-card-image.mdl-card {-->
    <!--width: 128px;-->
    <!--height: 128px;-->
    <!--}-->
    <!--.back-image-{{$i}}{-->
    <!--background: url({{$v |html}}) center / cover;-->
    <!--}-->
    <!--.demo-card-image > .mdl-card__actions {-->
    <!--height: 26px;-->
    <!--padding: 8px;-->
    <!--background: rgba(0, 0, 0, 0.2);-->
    <!--}-->
    <!--.demo-card-image__filename {-->
    <!--color: #fff;-->
    <!--font-size: 7px;-->
    <!--font-weight: 250;-->
    <!--}-->
    <!--.image-jump-to-article {-->
    <!--opacity: 0.0;-->
    <!--color: Transparent;-->
    <!--width: 128;-->
    <!--height: 128;-->
    <!--}-->
<!--}-->
</style>
{{end}}

<div class="mdl-grid">
    <div class="mdl-cell mdl-cell--6-col">
        <!--<form>-->
            <div class="demo-card-image mdl-card mdl-shadow--2dp back-image-0" id="back-image-0">
                <input type="submit" class="image-jump-to-article">
                <div class="mdl-card__actions">
                    <span class="demo-card-image__filename" id="rename0">パックマン</span>
                </div>
            </div>
        <!--</form>-->
    </div>
    <div class="mdl-cell mdl-cell--6-col">
        <!--<form>-->
            <div class="demo-card-image mdl-card mdl-shadow--2dp back-image-1" id="back-image-1">
                <input type="submit" class="image-jump-to-article">
                <div class="mdl-card__actions">
                    <span class="demo-card-image__filename" id="rename1">パックマン</span>
                </div>
            </div>
        <!--</form>-->
    </div>
</div>
<div id="centerCell" style="text-align: center;">
    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">
        <font size="3"><b>引き分け</b></font>
    </button>
</div>

<!--{{range $i, $v := .NameArray}}-->
<!--<script>-->
    <!--if({{$i}} == 0){-->
        <!--elem = document.getElementById("rename0");-->
        <!--console.log(elem.textContent);-->
        <!--document.getElementById("rename0").innerHTML = {{$v |html}};-->
        <!--console.log(elem.textContent);-->
    <!--}else if({{$i}} == 1){-->
        <!--elem = document.getElementById("rename1");-->
        <!--console.log(elem.textContent);-->
        <!--document.getElementById("rename1").innerHTML = {{$v |html}};-->
        <!--console.log(elem.textContent);-->
    <!--}-->
<!--</script>-->
<!--<button>{{$v |html}}</button>-->
<!--<span id="moga-{{$i}}">{{$v |html}}</span>-->
<!--{{end}}-->


<!--<script>-->
    <!--(function() {-->
        <!--document.getElementById("back-image-0").style.backgroundImage = "url(http://ucon.favclip.com/api/download/77b7f307-62ca-44d6-b007-e9f6267c7b7f)";-->
        <!--document.getElementById("back-image-1").style.backgroundImage = "url(http://ucon.favclip.com/api/download/742dc74d-dbbb-461c-ac36-8e28317d54b0)";-->
    <!--})();-->
<!--</script>-->

<script>
    //選択されたかどうかで初期化するかしないか用
    var sorted = false;
    //ソート対象の格納用
    var idols = [];
    //ソート状態保持用
    var idolsArray = [];
    //ソート時比較用親要素保持用
    var parent = [];
    //引き分け保持用
    var equal = [];
    //選択された要素一時保存用
    var selectedTmp = [];
    //マージ中配列ID(idolsArrayの第一インデックスi, 第二インデックスj)
    var tmp1i, tmp2i, tmp1j, tmp2j;
    //マージ回数
    var nMerge;
    //ソート回数
    var nSort;
    //ソート対象要素のマージ済み数
    var totalSize;
    //マージソート回数
    var finishSize;

    <!--document.getElementById("moga-4").innerHTML = "もがふぁいぶ";-->
    <!--initHoge();-->
    <!--function initHoge(){-->
        <!--console.log("ほげほげ");-->
    <!--}-->
    <!--document.getElementById("times").innerHTML = "<img src='//ex-chaos.appspot.com/api/download/a6162b79-f584-42a8-b08d-7df68566ca8e_large' width='300'>"-->

    //アイドルのIDとスコアのひも付け用オブジェクト
    function Person(id, score){
        this.id  = id;
        this.score = score;
        this.rank  = 0;
    }

    document.getElementById("centerCell").onclick = function(){
        if (sorted == false){
            mergeSort(0);
        }
    }
    document.getElementById("back-image-0").onclick = function(){
        if (sorted == false){
            mergeSort(-1);
        }
    }
    document.getElementById("back-image-1").onclick = function(){
        if (sorted == false){
            mergeSort(1);
        }
    }

    for (var i = 0; i < 10; i++) {
        idols[i] = new Person(i,0);
    }

    /**
     *サーバから受け取る氏名リストと画像リスト
     */
    imageUrls = [];
    names = [];
    idolsId = [];
    {{range $i, $v := .NameArray}}
        names[{{$i}}] = {{$v}};
    {{end}}
    {{range $i, $v := .FaceArray}}
        imageUrls[{{$i}}] = {{$v}};
    {{end}}
    {{range $i, $v := .TargetIdArray}}
        idolsId[{{$i}}] = {{$v |html}};
    {{end}}

    //開始
    initSort();

    /**
     * 状態表示
     */
    function showState() {
        document.getElementById("timesPer").style.width = Math.floor(finishSize * 100 / totalSize) + "%";
        document.getElementById("showTimesPer").innerHTML = Math.floor(finishSize * 100 / totalSize) + "%";
        document.getElementById("times").innerHTML = nSort + "回目";

        //比較要素の画像URL埋め込み
        lFactor = "url(" + imageUrls[idolsArray[tmp1i][tmp1j]] + ")";
        rFactor = "url(" + imageUrls[idolsArray[tmp2i][tmp2j]] + ")";

        document.getElementById("back-image-0").style.backgroundImage = lFactor
        document.getElementById("back-image-1").style.backgroundImage = rFactor
        document.getElementById("rename0").innerHTML = names[idolsArray[tmp1i][tmp1j]];
        document.getElementById("rename1").innerHTML = names[idolsArray[tmp2i][tmp2j]];

        nSort++;
        console.log(idolsId);
    }

    /**
     * 初期化
     */
    function initSort(){
        n = 0;
        mid = 0;
        lTmp = [];
        rTmp = [];

        for(var i = 0; i < {{.IdolLength |html}}; i++){
            rTmp[i] = i;
        }

        for(var i = 0; i < {{.IdolLength |html}}; i++){
            p = i;

            while(rTmp[p] == -1){
                pTmp = 0;
                if(p >= {{.IdolLength |html}} - 1){
                    pTmp = 0;
                }else{
                    pTmp = p + 1;
                }
                p = pTmp;
            }

            lTmp[i] = rTmp[p];
            rTmp[p] = -1;
        }

        //ソートする要素生成
        idolsArray[n] = [];
        for(var i = 0; i < idols.length; i++){
            idolsArray[n][i] = lTmp[i];
        }

        parent[n] = -1;
        totalSize = 0;
        n++;

        //分割
        for(var i = 0; i < idolsArray.length; i++){
            //要素数が2以上なら半分にし, 分割された配列をlstMemberの最後に加える
            if(idolsArray[i].length >= 2) {
                mid = parseInt(idolsArray[i].length / 2);

                idolsArray[n] = [];
                idolsArray[n] = idolsArray[i].slice(0, mid);
                totalSize += idolsArray[n].length;
                parent[n] = i;
                n++;

                idolsArray[n] = [];
                idolsArray[n] = idolsArray[i].slice(mid, idolsArray[i].length);
                totalSize += idolsArray[n].length;
                parent[n] = i;
                n++;
            }
        }

        //保存用配列
        for (var i = 0; i < idols.length; i++){
            selectedTmp[i] = 0;
        }

        nMerge = 0;

        for(var i = 0; i <= idols.length; i++){
            equal[i] = -1;
        }

        tmp1i = idolsArray.length - 2;
        tmp2i = idolsArray.length - 1;
        tmp1j = 0;
        tmp2j = 0;
        nSort = 1;
        finishSize = 0;

        showState();
    }

    /**
     * ソート終了時に結果を表示
     */
    function showResult() {
        str = "<table id=\"resultTable\">" + "<tr><th>順位<\/th><th>名前<\/th><\/tr>";

        postArray = [];
        for(var i = 0; i < idols.length; i++) {
            str += "<tr><td class = \"score\">" + idols[i].rank + "位<\/td>" + "<td class=\"name\" " + ">" + names[idols[i].id] + "<\/td><\/tr>";
            postArray.push(idols[i].id);
        }

        str += "<\/table><br>";

//        document.getElementById("selected").innerHTML = str;

        postQuery0 = idolsId[parseInt(postArray[0])];
        postQuery1 = idolsId[parseInt(postArray[1])];
        postQuery2 = idolsId[parseInt(postArray[2])];
        postQuery3 = idolsId[parseInt(postArray[3])];
        postQuery4 = idolsId[parseInt(postArray[4])];
//        postQuery0 = postArray[0];
//        postQuery1 = postArray[1];
//        postQuery2 = postArray[2];
//        postQuery3 = postArray[3];
//        postQuery4 = postArray[4];

        //ソート結果をサーバにPOST. リダイレクトしながらpostする.
//        $.ajax({
//            type: "POST",
//            url: "recommend",
//            data: {
//                postArray: postArray
//            }
//        });
        form = $('<form action="' + 'recommend' + '" method="post">' +
            '<input type="text" name="postArray[]" value="' + postQuery0.toString() + '"/>' +
            '<input type="text" name="postArray[]" value="' + postQuery1.toString() + '"/>' +
            '<input type="text" name="postArray[]" value="' + postQuery2.toString() + '"/>' +
            '<input type="text" name="postArray[]" value="' + postQuery3.toString() + '"/>' +
            '<input type="text" name="postArray[]" value="' + postQuery4.toString() + '"/>' +
            '</form>');
        $("body").append(form);
        form.submit();
    }

    /**
     * Personオブジェクトのソート
     */
    function sortIdols(a, b){
        if(a.score != b.score){
            return b.score - a.score;
        }else{
            return a.id - b.id;
        }
    }

    /**
     * 順位の決定(得点の計算)
     */
    function calcScore(){
        numEqual = 0;
        tmpScore = (idols.length - 1) * 3;

        for(var i = 0; i < idols.length; i++){
            numEqual = 0;
            if(i < idols.length - 1){
                for(var j = i; equal[idolsArray[0][j]] == idolsArray[0][j + 1]; j++){
                    numEqual++;
                }
            }

            idols[idolsArray[0][i]].score = tmpScore - numEqual * 2;
            if(i < idols.length - 1){
                for(var j = i; equal[idolsArray[0][j]] == idolsArray[0][j + 1]; j++){
                    i++;
                    idols[idolsArray[0][i]].score = tmpScore - numEqual * 2;
                }
            }

            tmpScore -= 3 * (numEqual + 1);
        }

        idols.sort(sortIdols);

        //順位の決定
        ranking = 0;
        for(var i = 0; i < idols.length; i++){
            ranking = i + 1;
            idols[i].rank = ranking;
            while((i < idols.length - 1) && (idols[i].score == idols[i + 1].score)){
                i++;
                idols[i].rank = ranking;
            }
        }
    }

    /**
     * マージソート
     * flag: 選択された要素
     * -1: 左
     * 0: 引き分け
     * 1: 右
     */
    function mergeSort(flag){
        //selectedTmpに保存. 下部に選択結果の表示.
        if(flag < 0){
            document.getElementById("selected").innerHTML = names[idols[idolsArray[tmp1i][tmp1j]].id];
            selectedTmp[nMerge] = idolsArray[tmp1i][tmp1j];

            tmp1j++;
            nMerge++;
            finishSize++;

            while(equal[selectedTmp[nMerge - 1]] != -1){
                selectedTmp[nMerge] = idolsArray[tmp1i][tmp1j];

                tmp1j++;
                nMerge++;
                finishSize++;
            }
        }else if(flag > 0){
            document.getElementById("selected").innerHTML = names[idols[idolsArray[tmp2i][tmp2j]].id];
            selectedTmp[nMerge] = idolsArray[tmp2i][tmp2j];

            tmp2j++;
            nMerge++;
            finishSize++;

            while(equal[selectedTmp[nMerge - 1]] != -1){
                selectedTmp[nMerge] = idolsArray[tmp2i][tmp2j];

                tmp2j++;
                nMerge++;
                finishSize++;
            }
        }else{
            document.getElementById("selected").innerHTML = "引き分け";
            selectedTmp[nMerge] = idolsArray[tmp1i][tmp1j];

            tmp1j++;
            nMerge++;
            finishSize++;

            while(equal[selectedTmp[nMerge - 1]] != -1){
                selectedTmp[nMerge] = idolsArray[tmp1i][tmp1j];

                tmp1j++;
                nMerge++;
                finishSize++;
            }

            equal[selectedTmp[nMerge - 1]] = idolsArray[tmp2i][tmp2j];
            selectedTmp[nMerge] = idolsArray[tmp2i][tmp2j];

            tmp2j++;
            nMerge++;
            finishSize++;

            while(equal[selectedTmp[nMerge - 1]] != -1){
                selectedTmp[nMerge] = idolsArray[tmp2i][tmp2j];

                tmp2j++;
                nMerge++;
                finishSize++;
            }
        }

        //片方のリストをマージし終えた後の, もう片方のリストのマージ
        if((tmp1j < idolsArray[tmp1i].length) && (tmp2j == idolsArray[tmp2i].length)){
            //リストtmp2iがマージ済, リストtmp1iの残りをコピー
            while(tmp1j < idolsArray[tmp1i].length){
                selectedTmp[nMerge] = idolsArray[tmp1i][tmp1j];

                tmp1j++;
                nMerge++;
                finishSize++;
            }
        }else if((tmp2j < idolsArray[tmp2i].length) && (tmp1j == idolsArray[tmp1i].length)){
            //リストtmp1iがマージ済, リストtmp2iの残りをコピー
            while (tmp2j < idolsArray[tmp2i].length){
                selectedTmp[nMerge] = idolsArray[tmp2i][tmp2j];

                tmp2j++;
                nMerge++;
                finishSize++;
            }
        }

        //両方のリストの最後に到達した場合, 親リストの更新
        if((tmp1j == idolsArray[tmp1i].length) && (tmp2j == idolsArray[tmp2i].length)){
            for(var i = 0; i < idolsArray[tmp1i].length + idolsArray[tmp2i].length; i++){
                idolsArray[parent[tmp1i]][i] = selectedTmp[i];
            }

            idolsArray.pop();
            idolsArray.pop();
            tmp1i = tmp1i - 2;
            tmp2i = tmp2i - 2;
            tmp1j = 0;
            tmp2j = 0;

            //新しいソートに入る前にselectedTmpを初期化
            if ((tmp1j == 0) && (tmp2j == 0)){
                for(var i = 0; i < idols.length; i++){
                    selectedTmp[i] = 0;
                }

                nMerge = 0;
            }
        }

        if(tmp1i < 0){
            document.getElementById("timesPer").style.width = Math.floor(finishSize * 100 / totalSize) + "%";
            document.getElementById("showTimesPer").innerHTML = Math.floor(finishSize * 100 / totalSize) + "%";
            document.getElementById("times").innerHTML = (nSort - 1) + "回目";

            sorted = true;

            calcScore();
            showResult();
        }else{
            showState();
        }
    }
</script>

{{end}}


<!--進捗率の表示-->
{{define "findolContentProgress"}}
<style>
    p.leftside{
        text-align: left;
    }
    p.center{
        text-align: center;
    }
</style>

<p> </p>
<p class="center"><font size="5"><b>気になる方をタップ！</b></font></p>
<p class="center"><font size="4"><b><span id="times"></span></b></font></p>
<p> </p>

<div class="progress">
    <div class="progress-bar progress-bar-success" id="timesPer"></div>
    <p class="leftside"><font size="4"><span id="showTimesPer"></span></font></p>
</div>

<p> </p>
<p class="center"><font size="4"><b><span id="selected"></span></b></font></p>

{{end}}
